<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="ko">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <!-- <meta http-equiv="X-UA-Compatible" content="ie=edge" /> -->
    <title>Camera Web App</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
      /* html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
      }

      #header {
        position: absolute;
        top: 50px;
        left: 50%;
        z-index: 999;
        color: white;
        text-align: center;
        transform: translate(-50%, -50%);
      }

      #header > p {
        font-size: 0.9em;
      } */

      #camera {
        position: absolute;
        top: 0;
        left: 0;
        /* width: 100%; */
        z-index: -1;
      }
      #camera--view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        object-fit: contain;
        /* transform: scaleX(-1); */
        filter: FlipH;
      }
      #rect {
        /* width: 100px;
        height: 100px; */
        position: absolute;
        border: 1px solid red;
        top: 0;
        left: 0;
        /* transform: translateX(calc(67%)); */
      }
      #cover {
        top: 0;
        left: 0;
      }

      #camera--trigger {
        width: 180px;
        color: white;
        background-color: black;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        padding: 15px 20px;
        text-align: center;
        box-shadow: 0 5px 10px 0 rgba(0, 0, 0, 0, 0.2);
        position: fixed;
        bottom: 3%;
        left: calc(50% - 90px);
      }
      #camera--output {
        object-fit: contain;
        position: relative;
      }

      /* .taken {
        height: 140px !important;
        width: 220px !important;
        border: solid 2px rgb(121, 200, 253);
      } */

      #guide {
        width: 180px;
        text-align: center;
        bottom: 10%;
        position: fixed;
        left: calc(50% - 90px);
      }
    </style>
  </head>
  <body>
    <!-- <div id="camera"> -->
    <div>
      <video id="camera--view"></video>
      <img src="//:0" alt="" id="camera--output" />
      <canvas id="rect"></canvas>
      <button onclick="takePic();" id="camera--trigger" type="button">
        사진촬영
      </button>
      <span id="guide">대상을 사각형 안에 위치해 주세요</span>
    </div>

    <script>
      let constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: 2000,
          height: 3000,
        },
        audio: false,
      };
      const camera = document.getElementById("camera");
      const cameraView = document.getElementById("camera--view");
      cameraView.setAttribute("playsinline", true);
      const cameraOutput = document.querySelector("#camera--output");
      const cameraTrigger = document.querySelector("#camera--trigger");
      const rect = document.getElementById("rect");

      navigator.mediaDevices
        .getUserMedia(constraints)
        .then((stream) => {
          cameraView.onloadedmetadata = () => {
            cameraView.play();
          };
          var vw = cameraView.clientWidth;
          var vh = cameraView.clientHeight;
          // cameraView.style.clip =
          //   "rect(" +
          //   vh * 0.2 +
          //   "px, " +
          //   vw * 0.8 +
          //   "px, " +
          //   (vh * 0.1 + vw * 0.6 * 1.414) +
          //   "px, " +
          //   vw * 0.2 +
          //   "px)";
          rect.style.width = `${vw * 0.6}px`;
          rect.style.height = `${vw * 0.6 * 1.414}px`;
          rect.style.transform =
            "translate(" + vw * 0.2 + "px," + vh * 0.2 + "px)";
          cameraView.srcObject = stream;
          // console.log(cameraView.videoWidth)
          console.log(cameraView.style.clip);
          // console.log(vw, vh);
          // cameraView.style.clip = "rect("+ 20 +"px," + 200 +"px," + 20 +"px," +200+ "px)"
          console.log();
         
        })
        .catch(function (err) {
          console.log(err.name + ": " + err.message);
        });

      function takePic() {
        const h = cameraView.clientHeight;
        const w = cameraView.clientWidth;
        var vw = cameraView.videoWidth;
        var vh = cameraView.videoHeight;
      
        html2canvas(camera).then((canvas) => {
          
          cameraOutput.src = canvas.toDataURL("image/webp");
        });

        // var canvas = document.createElement("canvas");
        // var ctx = canvas.getContext("2d");
        // canvas.width = rect.clientWidth;
        // canvas.height = rect.clientHeight;
        // console.log(h,w)
        // ctx.drawImage(
        //   cameraView,
        //   vw * 0.2,
        //   vh * 0.1,
        //   vw * 0.6,
        //   vw * 0.6 * 1.414,
        //   0,
        //   0,
        //   canvas.width,
        //   canvas.height
        // );
        // cameraOutput.style.display = "none";
        // cameraOutput.src = canvas.toDataURL("image/webp");
        // console.log(vw, vh);
        // console.log(cameraOutput.src);
        // console.log(
        //   "x: " +
        //     vw * 0.2 +
        //     " y: " +
        //     vh * 0.2 +
        //     " width: " +
        //     vw * 0.6 +
        //     " height: " +
        //     vw * 0.6 * 1.414
        // );
      }
    </script>
  </body>
</html>
